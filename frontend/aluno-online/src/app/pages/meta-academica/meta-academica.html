<div class="dashboard-wrapper">
  <header class="top-header">
    <div class="title-group">
      <h1>Minhas Avalia√ß√µes</h1>
      <span class="badge-semester">{{ currentSemester }}</span>
    </div>
    <div class="actions-group">
      <div class="gpa-card">CR Atual: <strong>{{ currentGPA | number:'1.1-2' }}</strong></div>
      <button class="btn-add" (click)="toggleModal()">+ Nova Avalia√ß√£o</button>
    </div>
  </header>

  <div class="main-layout">
    <aside class="sidebar">
      <section class="section-box">
        <h3>Disciplinas Atuais</h3>
        <div class="course-list">
          <div class="course-card all-courses" 
              (click)="viewAll()" 
              [class.active]="isViewingAll"
              [ngStyle]="isViewingAll ? {'background-color': '#f1f5f9', 'border-left-color': '#64748b', 'color': '#1e293b'} : {}">
            <span class="course-name">üìö Ver Todas</span>
          </div>

          <div *ngFor="let course of courses" 
              (click)="selectCourse(course)"
              class="course-card"
              [class.active]="course.active && !isViewingAll"
              [ngStyle]="course.active && !isViewingAll ? getCourseStyle(course.nome) : {}">
            <span class="course-name">{{ course.nome }}</span>
          </div>
        </div>
      </section>
    </aside>

    <main class="content">
      <div class="table-container">
        <div class="info-toast" [class.show]="info" [ngClass]="infoType" *ngIf="info">
          <div class="info-content">
            <i class="fa-solid" [ngClass]="{
              'fa-circle-check': infoType === 'success',
              'fa-circle-exclamation': infoType === 'warning',
              'fa-circle-info': infoType === 'info'
            }"></i>
            <span>{{ infoMessage }}</span>
          </div>
          <button class="close-info" (click)="info = false">&times;</button>
        </div>
        <table class="modern-table">
          <thead>
            <tr>
              <th>A√ß√µes</th>
              <th>Disciplina</th> 
              <th (click)="ordenar('nome')" class="sortable">Nome da Avalia√ß√£o</th>
              <th (click)="ordenar('tipo')" class="sortable">Tipo</th>
              <th (click)="ordenar('peso')" class="sortable">Peso</th>
              <th (click)="ordenar('nota')" class="sortable">Nota</th>
              <th (click)="ordenar('data')" class="sortable">Data</th> 
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of assessments">
              <td data-label="A√ß√µes">
                <div class="actions-cell">
                  <button class="btn-icon edit" (click)="editAssessment(item)" title="Editar">
                    <i class="fa-solid fa-pen-to-square"></i>
                  </button>
                  <button class="btn-icon delete" (click)="deleteAssessment(item.id!)" title="Excluir">
                    <i class="fa-solid fa-trash-can"></i>
                  </button>
                </div>
              </td>

              <td data-label="Disciplina" class="primary-text" style="font-weight: 600;">
                {{ pegaIniciais(item.codigo_disciplina) || 'N/A' }}
              </td>

              <td data-label="Avalia√ß√£o">
                <div class="name-wrapper">
                  <span class="primary-text">{{ item.nome }}</span>
                  <small class="warning-text" *ngIf="item.nota === null">
                    Pendente de realiza√ß√£o ou corre√ß√£o
                  </small>
                </div>
              </td>
              
              <td data-label="Tipo"><span class="type-pill">{{ item.tipo }}</span></td>
              <td data-label="Peso">{{ item.peso }}%</td>
              
              <td data-label="Nota">
                <span *ngIf="item.nota !== null" class="font-weight-bold">{{ item.nota | number:'1.1-1' }}</span>
                <span *ngIf="item.nota === null" class="placeholder-text">‚Äî</span>
              </td>

              <td data-label="Data">
                <span class="date-text" [ngClass]="getDateUrgencyClass(item.data)">
                  <i class="fa-regular fa-calendar-days" style="margin-right: 4px;" *ngIf="item.data"></i>
                  {{ item.data ? (item.data | date:'dd/MM/yyyy') : '--/--/----' }}
                </span>
              </td>
            </tr>

            <tr *ngIf="assessments.length === 0">
              <td colspan="7" style="text-align: center; color: var(--text-muted); padding: 40px;">
                Nenhuma avalia√ß√£o encontrada.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <aside class="analytics">
      <div class="insight-card">
        <header class="card-header">
          <h4>{{ isViewingAll ? 'Resumo do Semestre' : 'Resumo Acad√™mico' }}</h4>
          <div class="badge-status" *ngIf="!isViewingAll" [ngClass]="getStatusMessage()">
            {{ getStatusMessage() }}
          </div>
        </header>

        <div class="metrics-grid">
          <div class="mini-metric">
            <label>{{ isViewingAll ? 'M√©dia Geral' : 'M√©dia Atual' }}</label>
            <div class="value-compact" [style.color]="isViewingAll ? 'var(--text-main)' : 'var(--primary)'">
              {{ getMainDisplayAverage() | number:'1.1-1' }}
            </div>
          </div>

          <div class="mini-metric">
            <label>Impacto no CR</label>
            <div class="impact-badge" [ngClass]="calculateCRImpact() >= 0 ? 'positive' : 'negative'">
              {{ calculateCRImpact() >= 0 ? '‚ñ≤' : '‚ñº' }} {{ calculateCRImpact() | number:'1.3-3' }}
            </div>
          </div>
        </div>

        <div class="progress-section">
          <ng-container *ngIf="!isViewingAll; else creditosInfo">
            <div class="progress-bar-container">
              <div class="fill" [style.width.%]="calculateProgress()"></div>
            </div>
            <div class="progress-labels">
              <small>Progresso Notas</small>
              <small>{{ calculateProgress() }}%</small>
            </div>
          </ng-container>
          
          <ng-template #creditosInfo>
            <div class="credits-inline">
              <i class="fa-solid fa-graduation-cap"></i>
              <span><strong>{{ getTotalCredits() }}</strong> Cr√©ditos ativos</span>
            </div>
          </ng-template>
        </div>

        <div class="goals-calculator" *ngIf="!isViewingAll && selectedCourse">
          <h5><i class="fa-solid fa-calculator"></i> Notas M√≠nimas Necess√°rias</h5>
          <div class="goal-list">
            <div class="goal-item" *ngIf="getGoalCalculations() as goals">
              <span>Para Passar (7.0)</span>
              <strong [class.danger]="goals.toPass > 10">
                {{ (goals.toPass | number:'1.1-1') }}
              </strong>
            </div>
            <div class="goal-item" *ngIf="getGoalCalculations() as goals">
              <span>Manter CR ({{currentGPA}})</span>
              <strong [class.danger]="goals.toCR > 10">
                {{ (goals.toCR | number:'1.1-1') }}
              </strong>
            </div>
            <div class="goal-item" *ngIf="getGoalCalculations() as goals">
              <span>Recupera√ß√£o (4.0)</span>
              <strong [class.danger]="goals.toRecuperacao > 10">
                {{ (goals.toRecuperacao | number:'1.1-1') }}
              </strong>
            </div>
          </div>
        </div>

        <div class="estimated-box" *ngIf="isViewingAll">
          <small>Novo CR Estimado</small>
          <span class="gpa-projected">{{ (currentGPA + calculateCRImpact()) | number:'1.3-3' }}</span>
        </div>
      </div>
    </aside>
  </div>

  <div class="modal-backdrop" *ngIf="showModal" (click)="toggleModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>
        <i class="fa-solid" [ngClass]="isEditing ? 'fa-pen-to-square' : 'fa-circle-plus'" style="margin-right: 10px; color: var(--primary);"></i>
        {{ isEditing ? 'Editar Avalia√ß√£o' : 'Nova Avalia√ß√£o' }}
      </h2>
      
      <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">
        {{ isEditing ? 'Altere os campos abaixo para atualizar os dados.' : 'Preencha os dados da avalia√ß√£o para o acompanhamento.' }}
      </p>

      <form class="modal-form">
        <div class="form-group">
          <label>Disciplina</label>
          <select [(ngModel)]="newAssessment.codigo_disciplina" name="disciplina" [disabled]="isEditing">
            <option value="" disabled selected>Selecione a disciplina</option>
            <option *ngFor="let course of courses" [value]="course.codigo">
              {{ course.nome }}
            </option>
          </select>
          <small *ngIf="isEditing" style="color: var(--text-muted); font-size: 0.75rem; margin-top: 4px;">
            <i class="fa-solid fa-lock"></i> A disciplina n√£o pode ser alterada na edi√ß√£o.
          </small>
        </div>

        <div class="form-group">
          <label>Nome da Avalia√ß√£o</label>
          <input type="text" [(ngModel)]="newAssessment.nome" name="nome" placeholder="Ex: Prova 1">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Tipo</label>
            <select [(ngModel)]="newAssessment.tipo" name="tipo">
              <option value="Prova">Prova</option>
              <option value="Trabalho">Trabalho</option>
              <option value="Projeto">Projeto</option>
              <option value="Atividade">Atividade</option>
              <option value="Extra">Extra</option>
            </select>
          </div>
          <div class="form-group">
            <label>Peso (%)</label>
            <input type="number" [(ngModel)]="newAssessment.peso" name="peso">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Nota (opcional)</label>
            <input type="number" [(ngModel)]="newAssessment.nota" name="nota" step="0.1">
          </div>
          <div class="form-group">
            <label>Data</label>
            <input type="date" [(ngModel)]="newAssessment.data" name="data">
          </div>
        </div>
      </form>
      
      <div class="modal-footer">
        <button class="btn-ghost" (click)="toggleModal()">
          <i class="fa-solid fa-xmark" style="margin-right: 6px;"></i> Cancelar
        </button>
        <button class="btn-add" (click)="saveAssessment()">
          <i class="fa-solid fa-floppy-disk" style="margin-right: 6px;"></i> 
          {{ isEditing ? 'Atualizar' : 'Salvar' }}
        </button>
      </div>
    </div>
  </div>
</div>