<div class="dashboard-wrapper">
  <header class="dashboard-header">
    <div class="welcome-text">
      <h2>Ol√°, {{usuario?.nome}}! üëã</h2>
      <p>Bem-vindo ao novo portal do aluno. Veja o que h√° de novo hoje.</p>
    </div>
    
    <div class="sync-action">
      <button class="btn-sync" (click)="abrirModalSync()" [class.syncing]="loadingSync">
        <i class="fa-solid" [ngClass]="loadingSync ? 'fa-circle-notch fa-spin' : 'fa-arrows-rotate'"></i> 
        {{ loadingSync ? 'Sincronizando...' : 'Sincronizar Aluno Online' }}
      </button>

      <small *ngIf="loadingSync" class="pulse-text">Sincroniza√ß√£o em segundo plano...</small>
      <small *ngIf="ultimaSincronizacao && !loadingSync">√öltima vez: {{ ultimaSincronizacao }}</small>

      <div class="modal-overlay" *ngIf="exibirModalSync">
        <div class="modal-card">
          <header>
            <h3>Sincronizar Dados</h3>
            <button class="close-btn" (click)="fecharModalSync()">√ó</button>
          </header>

          <div class="modal-body">
            <div class="error-toast" *ngIf="mensagemErro">
              <i class="fa-solid fa-circle-xmark"></i> {{ mensagemErro }}
            </div>

            <div class="success-toast" *ngIf="mensagemSucesso">
              <i class="fa-solid fa-circle-check"></i> {{ mensagemSucesso }}
            </div>

            <ng-container *ngIf="!loadingSync && !mensagemSucesso">
              <p class="instruction">
                Insira suas credenciais do <strong>Portal Antigo</strong> para importar suas mat√©rias.
              </p>
              
              <div class="input-group">
                <label>Matr√≠cula</label>
                <input type="text" [(ngModel)]="syncData.matricula" placeholder="000000000000">
              </div>

              <div class="input-group">
                <label>Senha do Portal</label>
                <input type="password" [(ngModel)]="syncData.senha" placeholder="******">
              </div>

              <div class="legal-container">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="termosAceitos">
                  <span>Autorizo o acesso automatizado aos meus dados para fins de importa√ß√£o.</span>
                </label>
                <p class="legal-link" (click)="mostrarDetalhes = !mostrarDetalhes">
                  {{ mostrarDetalhes ? 'Ocultar detalhes legais' : 'Ver termos e responsabilidades' }}
                </p>
                <div class="legal-details" *ngIf="mostrarDetalhes">
                  Ao prosseguir, voc√™ concorda que esta aplica√ß√£o acesse o Portal do Aluno em seu nome para coletar disciplinas e notas. Suas credenciais s√£o usadas apenas para esta conex√£o e n√£o s√£o armazenadas. O uso desta ferramenta √© de sua inteira responsabilidade.
                </div>
              </div>
            </ng-container>

            <div class="loading-state" *ngIf="loadingSync">
              <div class="loader-content">
                <i class="fa-solid fa-circle-notch fa-spin"></i>
                <div class="loader-text">
                  <strong>{{ statusTexto }}</strong>
                  <p>Processando dados. Voc√™ pode fechar esta janela; o progresso continuar√° em segundo plano.</p>
                </div>
              </div>
              
              <div class="progress-bar-container">
                <div class="progress-bar-fill"></div>
              </div>
            </div>
          </div>

          <footer>
            <button class="btn-cancel" (click)="fecharModalSync()">
              {{ loadingSync ? 'Ocultar e continuar' : (mensagemSucesso ? 'Fechar' : 'Cancelar') }}
            </button>

            <button 
              class="btn-confirm"
              *ngIf="usuario?.role == 'ROLE_ADMIN' && !loadingSync && !mensagemSucesso"
              [disabled]="!termosAceitos"
              (click)="confirmarSincronizacao(true)"
            >
              <i class="fa-solid fa-bolt"></i>
              Executar ETL FULL (Admin)
            </button>

            <button class="btn-confirm" 
                    *ngIf="!loadingSync && !mensagemSucesso" 
                    [disabled]="!termosAceitos"
                    (click)="confirmarSincronizacao()">
              Confirmar Importa√ß√£o
            </button>
          </footer>
        </div>
      </div>
    </div>
  </header>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="icon-box blue"><i class="fa-solid fa-ranking-star"></i></div>
      <div class="info"><span>CR Geral</span><h3>{{statsAluno?.cr}}</h3></div>
    </div>
    <div class="stat-card">
      <div class="icon-box green"><i class="fa-solid fa-book"></i></div>
      <div class="info"><span>Disciplinas Ativas</span><h3>{{statsAluno?.discplinasAndamento}}</h3></div>
    </div>
    <div class="stat-card chart-card">
      <div class="chart-container">
        <svg viewBox="0 0 36 36" class="donut-chart">
          <path class="donut-ring"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
            fill="none" stroke="#eee" stroke-width="3" />
          
          <path class="donut-segment"
            [attr.stroke-dasharray]="statsAluno?.progressoCurso + ', 100'"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
            fill="none" stroke="#f39c12" stroke-width="3" stroke-linecap="round" />
        </svg>
        
        <div class="chart-percentage">
          <h3>{{ statsAluno?.progressoCurso | number:'1.0-0' }}%</h3>
        </div>
      </div>

      <div class="info">
        <span>Progresso do Curso</span>
        <p>{{ statsAluno?.creditosFeitos }} de {{ statsAluno?.totalCreditos }} cr√©ditos</p>
      </div>
    </div>
  </div>

  <section class="main-content">
    <div class="content-card">
      <h3>Grade Hor√°ria de Hoje</h3>
      
      <div class="aulas-grid" *ngIf="aulasAgrupadas.length > 0; else semAula">
        <div class="card-aula" *ngFor="let aula of aulasAgrupadas">
          <div class="aula-info">
            <h4>{{ aula.disciplina }}</h4>
            <span><i class="fa-solid fa-chalkboard-user"></i> {{ aula.professor }}</span>
          </div>
          
          <div class="aula-horarios">
            <span class="badge-horario" *ngFor="let h of aula.horarios">
              {{ h }}
            </span>
          </div>
        </div>
      </div>

      <ng-template #semAula>
        <p class="empty-state">Nenhuma aula registrada para hoje. Aproveite para estudar!</p>
      </ng-template>
    </div>
  </section>
</div>